<html>
    <head>
        <title>WebApp</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    </head>
    <body class="container">
        <hr>
        <h1>WebApp</h1>
        <hr>
        <form action="" method="post" novalidate>
            <p>
                <label for="region">Выберите регион:</label>
                <br>
                <select class="form-select" name="region" id="region">
                    {% for region in data.regions %}
                        <option value="{{ region.id }}">{{ region.name }}</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <label for="material">Выберите материал:</label>
                <br>
                <select class="material form-select" name="material">
                    {% for material in data.materials %}
                        <option value="{{ material.id }}">{{ material.name }}</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <a class="btn btn-primary" href="javascript:add()">Добавить</a>
                <a class="btn btn-primary" href="javascript:del()">Удалить</a>
                <a class="btn btn-primary" href="javascript:calculation()">Рассчитать</a>
            </p>
        </form>
        <div class="result-info" style="display: none;">
            <div class="result-info-title">Результат</div>
            <div class="result-region">
                <div class="result-region-title">Регион</div>
                <div class="result-region-info"></div>
            </div>
            <div class="result-material">
                <div class="result-material-title">Выбран материал</div>
                <div class="result-material-info">
                    <div class="result-variants-info">
                        <table class="result-variants-info-table table table-hover"></table>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        function add() {
            if ($('.material').length < 3) {
                $('.material:last').clone().insertAfter('.material:last');
            }
        }

        function del() {
            if ($('.material').length > 1) {
                $('.material:last').remove()
            }
        }

        function calculation() {
            region_id = $("#region").val();
            materials = [];

            material_blocks = $(".material")

            for (let i = 0; i < material_blocks.length; i++) {
                materials.push({
                    "material_id": material_blocks[i].value
                });
            }

            $.post('/calculation', {
                region_id: region_id,
                materials: materials
            }).done(function(response) {
                console.log(response);
                fillResults(response);
            }).fail(function() {
                console.log('error')
            });
        }

        function fillResults(data) {
            $('.result-info').css('display', 'block')
            $('.result-variants-info-table').text('');

            $('.result-region-info').text(data['region']);

            theadInner = '';
            data['materials'].forEach(material => {
                theadInner += '<th>' + material + '</th>';
            });
            theadInner += '<th>Общая ширина</th>';
            theadInner += '<th>Стоимость</th>';
            thead = '<thead><tr>' + theadInner + '</tr></thead>';

            tbodyInner = '';
            data['results'].forEach(variant => {
                trInner = '';

                sumWidth = 0
                sumPrice = 0
                variant.forEach(variantMaterial => {
                    sumWidth += Number(variantMaterial[1])
                    sumPrice += Number(variantMaterial[0])
                    trInner += '<td>' + variantMaterial[0] + ' (' + variantMaterial[1] + ' мм)' + '</td>';
                });

                trInner += '<td>' + sumWidth + ' мм' + '</td>'
                trInner += '<td>' + sumPrice + ' RUB' + '</td>'

                tbodyInner += '<tr>' + trInner + '</tr>';
            });

            tbody = '<tbody>' + tbodyInner + '</tbody>';
            table = thead + tbody
            
            $('.result-variants-info-table').append(table);
        }
    </script>
</html>
