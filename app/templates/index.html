<html>
    <head>
        <title>WebApp</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    </head>
    <body class="container">
        <style>
            body{
                background: linear-gradient(to top left, #c1f7ca, #98c2dd);
            }
            .form-select{
                background: linear-gradient(to top left, #c0d4e0, #dffde4);
                font-size: large;
            }
            label{
                font-size: 20px;
            }
        </style>
        <hr>
        <h1>WebApp</h1>
        <hr>
        <form action="" method="post" novalidate>
            <p>
                <label for="region">Выберите регион:</label>
                <br>
                <select class="form-select" name="region" id="region">
                    {% for region in data.regions %}
                        <option value="{{ region.id }}">{{ region.name }}</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <label for="material">Выберите материал:</label>
                <br>
                <select class="material form-select" name="material">
                    {% for material in data.materials %}
                        <option value="{{ material.id }}">{{ material.name }}</option>
                    {% endfor %}
                </select>
            </p>
            <p>
                <a class="btn btn-success" href="javascript:add()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square-fill" viewBox="0 0 16 16">
                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0z"></path>
                  </svg>   Добавить</a>
                <a class="btn btn-danger" href="javascript:del()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16">
                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"></path>
                  </svg>   Удалить</a>
                <a class="btn btn-primary" href="javascript:calculation()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calculator" viewBox="0 0 16 16">
                    <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"></path>
                    <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"></path>
                  </svg>   Рассчитать</a>
            </p>
        </form>
        <div class="result-info" style="display: none;">
            <!-- <div class="result-info-title">Результат</div> -->
            <!-- <div class="result-region"> -->
                <!-- <div class="result-region-title">Регион</div> -->
                <!-- <div class="result-region-info"></div> -->
            <!-- </div> -->
            <div class="result-material">
                <!-- <div class="result-material-title">Выбран материал</div> -->
                <div class="result-material-info">
                    <div class="result-variants-info" style="font-size: large;">Таблица вариантов
                        <table class="result-variants-info-table table table-hover"></table>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        function add() {
            if ($('.material').length < 3) {
                $('.material:last').clone().insertAfter('.material:last');
            }
        }

        function del() {
            if ($('.material').length > 1) {
                $('.material:last').remove()
            }
        }

        function calculation() {
            region_id = $("#region").val();
            materials = [];

            material_blocks = $(".material")

            for (let i = 0; i < material_blocks.length; i++) {
                materials.push({
                    "material_id": material_blocks[i].value
                });
            }

            $.post('/calculation', {
                region_id: region_id,
                materials: materials
            }).done(function(response) {
                console.log(response);
                fillResults(response);
            }).fail(function() {
                console.log('error')
            });
        }

        function fillResults(data) {
            $('.result-info').css('display', 'block')
            $('.result-variants-info-table').text('');

            $('.result-region-info').text(data['region']);

            theadInner = '';
            theadInner += '<th>№</th>'
            data['materials'].forEach(material => {
                theadInner += '<th>' + material + '</th>';
            });
            theadInner += '<th>Общая ширина</th>';
            theadInner += '<th>Стоимость</th>';
            thead = '<thead><tr>' + theadInner + '</tr></thead>';

            count = 1
            tbodyInner = '';
            data['results'].forEach(variant => {
                trInner = '';
                trInner += '<td>' + count + '</td>'
                count += 1
                sumWidth = 0
                sumPrice = 0
                variant.forEach(variantMaterial => {
                    sumWidth += Number(variantMaterial[1])
                    sumPrice += Number(variantMaterial[2])
                    trInner += '<td>' + variantMaterial[0] + ' (' + variantMaterial[1] + ' мм)' + '</td>';
                });

                trInner += '<td>' + sumWidth + ' мм' + '</td>'
                trInner += '<td>' + sumPrice + ' RUB' + '</td>'

                tbodyInner += '<tr>' + trInner + '</tr>';
            });

            tbody = '<tbody>' + tbodyInner + '</tbody>';
            table = thead + tbody
            
            $('.result-variants-info-table').append(table);
        }
    </script>
</html>
